<?php

namespace App\Http\Controllers\Warranty;

use App\Http\Controllers\Controller;
use App\Http\Requests\Warranty\WrFormRequest;
use App\Models\MasterWaaranty\TblHistoryProd;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use Inertia\Inertia;

class WarrantyFormController extends Controller
{

    // public function form()
    // {
    //     try {
    //         $uri = env('ROCKET_GET_CHANEL_BUY_URI');
    //         $response = Http::timeout(30)->withOptions(['verify' => false])->get($uri, [
    //             'name' => '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠',
    //         ]);

    //         if ($response->successful() && $response->status() === 200) {
    //             $response_json = $response->json();
    //             $response_json = $response_json['data'];
    //         } else {
    //             $response_json = [];
    //         }
    //         return Inertia::render('Warranty/WarrantyForm', ['channel_list' => $response_json]);
    //     } catch (\Exception $e) {
    //         return Inertia::render('Warranty/WarrantyForm', ['channel_list' => []]);
    //     }
    // }

    public function form()
    {
        $channel_list = [];

        try {
            $uri = env('ROCKET_GET_CHANEL_BUY_URI');

            Log::info('üõ∞ [WarrantyFormController] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î channel_list', ['uri' => $uri]);

            $response = Http::timeout(15)->withOptions(['verify' => false])->get($uri, [
                'name' => '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠',
            ]);

            if ($response->successful()) {
                $data = $response->json();

                Log::info('üì¨ [WarrantyFormController] ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Rocket', [
                    'status' => $response->status(),
                    'preview' => mb_substr(json_encode($data), 0, 200),
                ]);

                // ‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à key ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡∏ä‡∏±‡∏î
                if (isset($data['data']) && is_array($data['data'])) {
                    $channel_list = $data['data'];
                } elseif (isset($data['list']) && is_array($data['list'])) {
                    $channel_list = $data['list'];
                } else {
                    Log::warning('‚ö†Ô∏è [WarrantyFormController] ‡πÑ‡∏°‡πà‡∏°‡∏µ key data/list ‡πÉ‡∏ô response');
                    $channel_list = [];
                }
            } else {
                Log::error('‚ùå [WarrantyFormController] Rocket API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', [
                    'status' => $response->status(),
                    'body' => $response->body(),
                ]);
            }
        } catch (\Throwable $e) {
            Log::error('üí• [WarrantyFormController] ‡∏î‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', [
                'message' => $e->getMessage(),
            ]);
        }

        return Inertia::render('Warranty/WarrantyForm', [
            'channel_list' => $channel_list,
        ]);
    }

    public function get_store_name($store_name)
    {
        try {
            $merchant_id = env('MERCHANT_ID_ROCKET');
            $accessToken = env('ACCESS_TOKEN_ROCKET');
            $uri = env('ROCKET_GET_CHANEL_BUY_URI_DETAIL');
            Log::info('üõ∞ [get_store_name] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', [
                'store_name'   => $store_name,
                'uri'          => $uri,
                'merchant_id'  => $merchant_id,
            ]);
            $response = Http::timeout(30)->withOptions([
                'verify' => false, // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SSL
            ])->withHeaders([
                'access-token' => $accessToken,
                'merchant-id'  => $merchant_id,
                'charset'      => 'utf-8',
                'Content-Type' => 'application/json',
            ])->get($uri, [
                'name' => $store_name,
            ]);

            Log::info('üì° [get_store_name] ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Rocket API', [
                'status' => $response->status(),
                'successful' => $response->successful(),
                'body_preview' => mb_substr($response->body(), 0, 300) . '...',
            ]);


            if ($response->successful() && $response->status() === 200) {
                $response_json = $response->json();

                Log::info('‚úÖ [get_store_name] ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Rocket', [
                    'response_json' => $response_json,
                ]);

                return response()->json([
                    'message' => '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    'list' => $response_json
                ]);
            } else {
                throw new \Exception('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ (HTTP ' . $response->status() . ')');
            }
        } catch (\Exception $e) {
            return response()->json([
                'message' => $e->getMessage(),
                'list' => []
            ], 400);
        }
    }

    //‡πÄ‡∏ä‡πä‡∏Ñ‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å Serial Number ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    public function checkSn(Request $request)
    {
        $sn = $request->input('sn');
        $status = 400;
        $data_response = [];

        try {
            if (empty($sn)) {
                throw new \Exception('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•');
            }

            Log::info('üõ∞ [WarrantyFormController] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏à‡∏≤‡∏Å API', ['sn' => $sn]);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å API ‡∏Å‡πà‡∏≠‡∏ô (VITE_R_MAIN_SERIAL)
            $response = Http::timeout(30)
                ->withOptions(['verify' => false])
                ->post(env('VITE_R_MAIN_SERIAL'), [
                    'sn' => $sn,
                    'view' => 'sigle',
                ]);

            if (!$response->successful()) {
                throw new \Exception('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ (HTTP ' . $response->status() . ')');
            }

            $response_json = $response->json();

            Log::info('üì° [WarrantyFormController] ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å API VITE_R_MAIN_SERIAL', [
                'status' => $response_json['status'] ?? null,
                'warrantyexpire' => $response_json['warrantyexpire'] ?? null,
                'skuset' => $response_json['skuset'] ?? [],
            ]);

            // ‡∏ñ‡πâ‡∏≤ API ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö SUCCESS
            if (($response_json['status'] ?? '') !== 'SUCCESS') {
                throw new \Exception('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
            }

            // ‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            if ($response_json['warrantyexpire'] === true || $response_json['warrantyexpire'] === 'true') {
                throw new \Exception('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
            }

            // ‡∏ñ‡πâ‡∏≤ SN ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
            $check_form_history = TblHistoryProd::query()
                ->where('serial_number', $sn)
                ->select('serial_number', 'model_code', 'product_name', 'model_name')
                ->first();

            if ($check_form_history) {
                throw new \Exception('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            }

            // ‡∏ñ‡πâ‡∏≤ SN ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‚Üí ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å API VITE_R_MAIN_PRODUCT
            $assetKey = $response_json['skuset'][0] ?? null;
            $asset = $response_json['assets'][$assetKey] ?? null;

            if (!$asset) {
                throw new \Exception('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô API Serial Response');
            }

            $model_code = $asset['pid'] ?? null;
            Log::info('üß© [WarrantyFormController] ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Product Detail', ['model_code' => $model_code]);

            $productResponse = Http::timeout(30)
                ->withOptions(['verify' => false])
                ->post(env('VITE_R_MAIN_PRODUCT'), [
                    'pid' => $model_code,
                    'views' => 'single',
                ]);

            $productDetail = [];
            if ($productResponse->successful()) {
                $product_json = $productResponse->json();
                if (($product_json['status'] ?? '') === 'SUCCESS' && !empty($product_json['assets'][0])) {
                    $pd = $product_json['assets'][0];
                    $productDetail = [
                        'pid' => $pd['pid'] ?? '',
                        'pname' => $pd['pname'] ?? '',
                        'fac_model' => $pd['facmodel'] ?? '',
                        'image' => $pd['imagesku'] ?? '',
                        'warrantyperiod' => $pd['warrantyperiod'] ?? '',
                        'warrantycondition' => $pd['warrantycondition'] ?? '',
                        'warrantynote' => $pd['warrantynote'] ?? '',
                        'sp_warranty' => $pd['sp_warranty'] ?? [],
                    ];
                }
            }

            // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏à‡∏≤‡∏Å Serial API + Product API)
            $data_response = [
                'serial_info' => $response_json,
                'product_detail' => $productDetail,
            ];

            return response()->json([
                'message' => "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç S/N: {$sn} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
                'data' => $data_response
            ], 200);
        } catch (\Exception $e) {
            Log::error('‚ùå [WarrantyFormController] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', [
                'sn' => $sn,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'message' => $e->getMessage(),
                'data' => $data_response ?? [],
            ], $status ?? 400);
        }
    }

    //‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô
    public function store(WrFormRequest $request)
    {
        try {
            DB::beginTransaction();
            $req = $request->validated();

            $full_path = null;
            if ($request->hasFile('warranty_file')) {
                $file = $request->file('warranty_file');
                $fileName = time() . '_' . uniqid() . '.' . $file->getClientOriginalExtension();
                $path = 'warranty_slips/' . $fileName;
                Storage::disk('s3')->put($path, file_get_contents($file), 'private');
                $full_path = Storage::disk('s3')->url($path);
            }

            $store = TblHistoryProd::create([
                'approval' => '',
                'lineid' => Auth::user()->line_id ?? Auth::user()->google_id ?? null,
                'cust_tel' => $req['phone'],
                'reward' => null,
                'serial_number' => $req['serial_number'],
                'model_code' => $req['model_code'],
                'model_name' => $req['model_name'],
                'product_name' => $req['product_name'],
                'buy_from' => $req['buy_from'],
                'store_name' => $req['store_name'],
                'buy_date' => $req['buy_date'],
                'slip' => $full_path,
                'approver' => null,
                'round' => null,
                'warranty_from' => 'pumpkin_multi_local',
                'customer_code' => $req['customer_code'] ?? null,
                'customer_name' => $req['customer_name'] ?? null,
            ]);

            DB::commit();

            try {
                $lineUid = $store->lineid;
                $token = env('LINE_CHANNEL_ACCESS_TOKEN');

                Log::info('üü¢ LINE Push Attempt', [
                    'uid' => $lineUid,
                    'token_exists' => !empty($token),
                ]);

                if (!$lineUid) {
                    Log::warning('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ lineid ‡πÉ‡∏ô record', ['store_id' => $store->id]);
                    return redirect()->route('warranty.history');
                }

                if (empty($token)) {
                    Log::error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö LINE_CHANNEL_ACCESS_TOKEN ‡πÉ‡∏ô .env');
                    return redirect()->route('warranty.history');
                }

                $baseDetail =
                    "üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:\n" .
                    "‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: " . ($store->product_name ?? '-') . "\n" .
                    "‚Ä¢ ‡∏£‡∏∏‡πà‡∏ô: " . ($store->model_name ?? '-') . "\n" .
                    "‚Ä¢ Model Code: " . ($store->model_code ?? '-') . "\n" .
                    "‚Ä¢ Serial Number: " . ($store->serial_number ?? '-') . "\n" .
                    "‚Ä¢ ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: " . ($store->store_name ?? '-') . "\n" .
                    "‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: " . ($store->buy_date ?? '-') . "\n";

                $message = [
                    'to' => $lineUid,
                    'messages' => [[
                        'type' => 'text',
                        'text' =>
                        "‡∏Ç‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô üôè\n" .
                            // $baseDetail .
                            "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ",
                    ]],
                ];

                $response = Http::withHeaders([
                    'Content-Type' => 'application/json',
                    'Authorization' => 'Bearer ' . $token,
                ])->post('https://api.line.me/v2/bot/message/push', $message);

                Log::info('üì¨ LINE Push Response', [
                    'status' => $response->status(),
                    'body' => $response->body(),
                ]);

                if ($response->failed()) {
                    Log::warning('‚ö†Ô∏è LINE Push Message Failed', [
                        'uid' => $lineUid,
                        'response' => $response->body(),
                    ]);
                }
            } catch (\Exception $ex) {
                Log::error('‚ùå LINE Push Error', [
                    'error' => $ex->getMessage(),
                    'lineid' => $store->lineid,
                ]);
            }

            return redirect()->route('warranty.history');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('‚ùå Error in WarrantyFormController@store', [
                'error' => $e->getMessage(),
            ]);
            return back()->withErrors(['error' => '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' . $e->getMessage()]);
        }
    }
}
